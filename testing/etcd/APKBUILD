# Maintainer: Dan Williams <dan@ma.ssive.co>
pkgname=etcd
pkgver=3.3.5
pkgrel=0
pkgdesc="Distributed reliable key-value store for the most critical data of a distributed system"
url="https://github.com/coreos/etcd"
arch="all"
license="Apache-2.0"
makedepends="go go-tools bash"
source="$pkgname-$pkgver.tar.gz::${url}/archive/v${pkgver}.tar.gz
	disable-race-tests-on-alpine.patch
	etcd.initd
	etcd.monitd
	etcd.confd"
builddir="$srcdir/src/github.com/coreos/etcd"
install="$pkgname.pre-install $pkgname.post-install"

export GOPATH="$srcdir"

prepare() {
	mkdir -p ${builddir%/*}
	mv "$srcdir"/$pkgname-$pkgver "$builddir"/
	default_prepare
}

build() {
	cd "$builddir"
	./build
}

# check() {
# 	cd "$builddir"
# 	./test
# }

package() {
	install -Dm755 "$builddir"/bin/etcd "$pkgdir"/usr/bin/etcd
	install -Dm755 "$builddir"/bin/etcdctl "$pkgdir"/usr/bin/etcdctl

	install -Dm600 "$srcdir"/etcd.confd "$pkgdir"/etc/conf.d/$pkgname
	install -Dm755 "$srcdir"/etcd.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm600 "$srcdir"/etcd.monitd "$pkgdir"/etc/monit.d/$pkgname.conf

	mkdir -p "$pkgdir"/var/log/
	touch "$pkgdir"/var/log/etcd.log
	chown 20006:30006 "$pkgdir"/var/log/etcd.log
}

sha512sums="e4495a02f1e2a08cc70a055528edbc118f50e4fe68b51afeb82908a7c2387de1e457adfb8078befec6829daeace61b95501da9f8b3fa49e0aecc9710ece470a4  etcd-3.3.5.tar.gz
56c2ccdfa3490362622fcd5a7b11c5ba848890817f42e9d59ee1e281666e98168d8f17e8f5cfd76cdea25606fb60d95d4653bd528d3f54ec5a8f9a4ce93028c9  disable-race-tests-on-alpine.patch
2114d086f3d279db70df9128c031f982b91bb08018df020afcd516e5db0b0249f91816b3eaabd38b31dd8370ad884507f2ca63dff2cd464236e9234248a68916  etcd.initd
a1ea4b3acaadbd09f580b2fe96875069731b8d439fa0ec334ec9ae1cf4e7cddc22f634cf3ea04771af5885d707a689631999f979149ee6357e60c2ea8f21129d  etcd.monitd
503707fa15b40ab8ff73436b5abc0406ff8fcbb0acc8dbb463fb8c3243924c7f569ff766ab375d4eb8aeb28f49d8b4eaeee958b9d7f84cac2d05b54b6f5aab76  etcd.confd"
